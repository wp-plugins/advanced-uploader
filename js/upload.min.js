'use strict';'use strict';var max_file_size_display=0;var adv_max_file_size_display=0;var default_action;var default_url;var blobSlice;var requestFileSystem;var up_plupload;var msgProgLabel=document.createElement("label");msgProgLabel.className="pLabel";var msgProgress=document.createElement("progress");var msgProgressDiv=document.createElement("div");msgProgressDiv.className="progress";msgProgressDiv.appendChild(msgProgLabel);msgProgressDiv.appendChild(msgProgress);if(typeof wpUploaderInit==='object')var plupload_defaults=wpUploaderInit;if(typeof _wpPluploadSettings==='object')var plupload_defaults=_wpPluploadSettings.defaults;(function(j){j["mOxieFileAPIReader"]=function(i){return function(e,f,g){var h=new mOxie.FileReader();h.onload=function(a){var b=this.result.search(/;base64,/);var c=this.result.slice(b+8);var d=new D(window.atob(c));f(d)};h.readAsDataURL(i)}}})(this);var max_file_size=parseInt(plupload_defaults.filters.max_file_size);if(adv_uploader){plupload_defaults.filters.max_file_size=adv_max_file_size}plupload_defaults.preinit={PostInit:function(b){var c=jQuery('#plupload-upload-ui');if(c.length!=0){setResize(getUserSetting('upload_resize',false));if(b.features.dragdrop&&!jQuery(document.body).hasClass('mobile')){c.addClass('drag-drop');jQuery('#drag-drop-area').bind('dragover.wp-uploader',function(){c.addClass('drag-over')}).bind('dragleave.wp-uploader, drop.wp-uploader',function(){c.removeClass('drag-over')})}else{c.removeClass('drag-drop');jQuery('#drag-drop-area').unbind('.wp-uploader')}if(b.runtime=='html4')jQuery('.upload-flash-bypass').hide()}default_action=b.settings.multipart_params['action'];default_url=b.settings.url;up_plupload=b;jQuery('.drop-instructions').show();b.settings.drop_element[0].addEventListener('dragenter',function(e){var a=document.getElementsByClassName('uploader-window');if(a.length>0){a[0].style.display='block';a[0].style.opacity=1;a[0].addEventListener('dragleave',function(e){a[0].style.display='none';a[0].style.opacity=0},false);a[0].addEventListener('drop',function(e){a[0].style.display='none';a[0].style.opacity=0},false)}},false);b.settings.resize=new Object;b.settings.resize.enabled=false;if(adv_uploader){b.settings.chunk_size=max_file_size;b.settings.filters.max_file_size=adv_max_file_size}},FilesAdded:function(a,b){if(adv_uploader){a.settings.url=ajaxurl;a.settings.multipart_params['destinations']=JSON.stringify(destinations);a.settings.multipart_params['action']='adv_upload_plupload';a.settings.multipart_params['security']=security;if(typeof wpUploaderInit==='object'&&typeof b[0].dest==='undefined'){selectDestination(b,function(){a.trigger("FilesAdded",b)});return false}else if(typeof b[0].dest==='undefined'){for(var i=0;i<b.length;i++)b[i].dest=0}}else{a.settings.url=default_url;a.settings.max_retries=0;delete a.settings.multipart_params['destinations'];a.settings.multipart_params['action']=default_action;delete a.settings.multipart_params['security']}},BeforeUpload:function(a,b){if(adv_uploader){a.settings.multipart_params['fileDest']=b.dest;a.settings.multipart_params['album']=b.album}},FileUploaded:function(p,q,r){if(adv_uploader){var s=function(d,f,g){var h=new FormData();h.append('action','adv_file_upload_thumbs');h.append('security',security);h.append('filename',t.data.name);if(typeof _wpPluploadSettings==='object')h.append('post_id',wp.media.model.settings.post.id);h.append('meta',JSON.stringify(f));h.append('fileDest',q.dest);h.append('album',q.album);h.append('destinations',JSON.stringify(destinations));for(var j=0;j<g.length;j++){var k=g[j];var l=atob(d[k].split(',')[1]);var m=[];for(var i=0;i<l.length;i++){m.push(l.charCodeAt(i))}var n=new Blob([new Uint8Array(m)],{type:'image/png'});h.append('thumbs[]',n,f[k].file)}var o=jQuery('#media-item-'+q.id);jQuery('.percent',o).html('Completing Upload');jQuery.ajax({'type':"post",'url':ajaxurl,'data':h,'enctype':'multipart/form-data','encoding':'multipart/form-data','cache':false,'processData':false,'contentType':false}).done(function(a){if(typeof a==='string'&&a!=''){if(typeof _wpPluploadSettings==='object')p.trigger("FileUploaded",q,{'response':a});else{try{var b=JSON.parse(a)}catch(e){p.trigger("FileUploaded",q,{'response':'media-upload-error'});return}if(b.data.id==false){var c=b.data.id;jQuery('#media-item-'+q.id+' .progress').remove();jQuery('#media-item-'+q.id+' .original').remove();jQuery('<img>').attr({src:b.data.url,class:'pinkynail'}).appendTo('#media-item-'+q.id);jQuery('<div>').attr({class:'filename new'}).html(b.data.name).appendTo('#media-item-'+q.id)}else var c=b.data.id.toString();p.trigger("FileUploaded",q,{'response':c})}}})};try{var t=JSON.parse(r.response)}catch(e){return}if(t.success=='file_complete'){var u=t.data.name.split('.').pop();if(destinations[q.dest][4]&&u.match(/jpg|jpeg|png/i)){var v=jQuery('#media-item-'+q.id);jQuery('.percent',v).html('Creating thumbs');createThumbImage(q,t.data.name,s,t.data.file)}else if(destinations[q.dest][4]&&u.match(/pdf/i)){var v=jQuery('#media-item-'+q.id);jQuery('.percent',v).html('Creating thumbs');pdf(t.data.file,t.data.name,s)}else s(null,null,new Array());return false}}}};var registerLog=function(a,b){jQuery('<div class="'+b+'">'+a+'</div>').appendTo('#log')};function toggle_loader(a){if(a=='default'){jQuery('#adv_upload').toggleClass('hidden',true);jQuery('#default_upload').toggleClass('hidden',false)}else{jQuery('#default_upload').toggleClass('hidden',true);jQuery('#adv_upload').toggleClass('hidden',false)}jQuery.ajax({'type':"post",'url':ajaxurl,'data':{'action':"adv_file_upload_set_loader",'loader':a}})}function convertBytes(a){var b='Bytes';if((a%1024)==0){a=a/1024;b='KB'}if(b=='KB'&&(a%1024)==0){a=a/1024;b='MB'}if(b=='MB'&&(a%1024)==0){a=a/1024;b='GB'}return a+b}jQuery(document).ready(function(){jQuery('.media-upload-form').on('click.uploader',function(e){var a=jQuery(e.target);if(a.is('.upload-flash-bypass a')||a.is('a.uploader-html')){var b=jQuery('.max-upload-size').html();b=b.replace(adv_max_file_size_display,max_file_size_display);jQuery('.max-upload-size').html(b);jQuery('#adv_uploader_checkbox_p').hide()}else if(a.is('.upload-html-bypass a')){jQuery('#adv_uploader_checkbox_p').show();if(adv_uploader){var b=jQuery('.max-upload-size').html();b=b.replace(max_file_size_display,adv_max_file_size_display);jQuery('.max-upload-size').html(b)}}});if(adv_replace_default){max_file_size_display=convertBytes(max_file_size);adv_max_file_size_display=convertBytes(adv_max_file_size);var c='';var d=max_file_size_display;if(adv_uploader){c='checked';d=adv_max_file_size_display}var f='<p id="adv_uploader_checkbox_p" style="cursor: pointer;">'+'<input type="checkbox" id="adv_uploader_checkbox" style="margin-right: 5px;" '+c+'>Use advanced uploader</p>';var g=document.getElementById('tmpl-uploader-inline');if(g!==null){var h=new RegExp(max_file_size_display,'i');var i=g.innerHTML.search(h);var j=g.innerHTML.indexOf('</p>',i);g.innerHTML=g.innerHTML.substring(0,i)+d+g.innerHTML.substring(i+max_file_size_display.length,j+4)+f+g.innerHTML.substring(j+4)}var k=jQuery('.max-upload-size').html();if(typeof k==='string'){var h=new RegExp(max_file_size_display,'i');var i=k.search(h);jQuery('.max-upload-size').html(k.substring(0,i)+d+k.substring(i+max_file_size_display.length)).after(f)}jQuery(document).on('click','#adv_uploader_checkbox_p',show_hide_uploader);jQuery(document).on('click','.media-menu-item',function(e){if(e.target.textContent=='Upload Files')if((!adv_uploader&&jQuery('#adv_uploader_checkbox').attr('checked')=='checked')||(adv_uploader&&jQuery('#adv_uploader_checkbox').attr('checked')==undefined))jQuery('#adv_uploader_checkbox_p').click()})}});function show_hide_uploader(e){if(e.target.id.indexOf('adv_uploader_checkbox')==-1)return;if(e.target.type=='checkbox')var a=e.target;else{var a=document.getElementById('adv_uploader_checkbox');if(a.checked)a.checked=false;else a.checked=true}if(a.checked){adv_uploader=true;up_plupload.settings.filters.max_file_size=adv_max_file_size;up_plupload.settings.chunk_size=max_file_size;var b=jQuery('.max-upload-size').html();b=b.replace(max_file_size_display,adv_max_file_size_display);jQuery('.max-upload-size').html(b)}else{adv_uploader=false;up_plupload.settings.filters.max_file_size=max_file_size;up_plupload.settings.chunk_size=0;var b=jQuery('.max-upload-size').html();b=b.replace(adv_max_file_size_display,max_file_size_display);jQuery('.max-upload-size').html(b)}jQuery.ajax({'type':"post",'url':ajaxurl,'data':{'action':"adv_file_upload_set_loader",'loader':adv_uploader}})}var createThumbImage=function(o,p,q,r){var s=new Image();s.src=r;s.onload=function(){var a=s.width;var b=s.height;if(b>sizes['thumbnail']['height']||a>sizes['thumbnail']['width']){var c=new Object();var d=new Object();var e=new Array();var f=b;var g=a;var h='';for(var i in sizes){var b=f;var a=g;var j=sizes[i]['width'];var k=sizes[i]['height'];if(b>k||a>j){if(a>f){if(a>j){b*=j/a;a=j}}else{if(b>k){a*=k/b;b=k}}a=Math.round(a);b=Math.round(b);var l=p.replace(/\.(jpg|jpeg|png)$/i,"-"+a+"x"+b+".png");if(h.search(l)==-1){h+=l+';';var m=document.createElement('canvas');m.width=a;m.height=b;var n=m.getContext("2d");n.drawImage(this,0,0,a,b);e.push(i);d[i]=m.toDataURL("image/png")}c[i]=new Object();c[i].file=l;c[i].width=a;c[i].height=b}}q(d,c,e)}else q(null,null,new Array())}};var pdf=function(p,q,r){PDFJS.disableWorker=true;var s=null;function renderPage(d){s.getPage(d).then(function(a){var b=new Array();for(var c in sizes)b.push(c);createPDFthumb(a,'',b,new Array(),new Object(),new Object())})}function createPDFthumb(a,b,c,d,e,f){var g=c.pop();var h=sizes[g]['width']/a.getViewport(1.0).width;var i=sizes[g]['height']/a.getViewport(1.0).height;var j=h>i?i:h;var k=a.getViewport(j);var l=document.createElement('canvas');var m=l.getContext('2d');l.height=k.height;l.width=k.width;var n=q+"-"+l.width+"x"+l.height+".png";e[g]=new Object();e[g].file=n;e[g].width=l.width;e[g].height=l.height;if(b.search(n)==-1){b+=n+';';var o={canvasContext:m,viewport:k};a.render(o).then(function(){d.push(g);f[g]=l.toDataURL("image/png");if(c.length>0)createPDFthumb(a,b,c,d,e,f);else{r(f,e,d)}})}else{if(c.length>0)createPDFthumb(a,b,c,d,e,f);else{r(f,e,d)}}}var t={};var u=new FileReader();u.onload=function webViewerChangeFileReaderOnload(b){var c=b.target.result;t.data=new Uint8Array(c);PDFJS.getDocument(t).then(function getPdfForm(a){s=a;renderPage(1)})};PDFJS.getDocument(p).then(function getPdfForm(a){s=a;renderPage(1)})};function handleDragOver(a){a.stopPropagation();a.preventDefault();a.dataTransfer.dropEffect='copy'}function handleDragEnter(a){a.currentTarget.classList.add('drag-over')}function handleDragLeave(a){a.currentTarget.classList.remove('drag-over')}function selectDestination(l,m){if(l.length==0){return}var n='<option value="">Select Destination</option>';var o="";for(var i=0;i<destinations.length;i++){if(o!=destinations[i][2]){if(o!=""){n+='</optgroup>'}n+='<optgroup label="'+destinations[i][2]+'">'}n+='<option value="'+i+'">'+destinations[i][0]+'</option>';o=destinations[i][2]}if(o!=""){n+='</optgroup>'}var p='<option value="">Select category</option>';for(var i=0;i<categories.length;i++){p+='<option class="'+categories[i][2]+'" value="'+i+'">'+categories[i][1]+'</option>'}if(l.length>1)var q='<p>Select destination for all files';else var q='<p>Select destination for '+l[0].name;q+='<select id="dest">';q+=n;q+='</select>';q+='<span id="wg_" class="hide gallery_name"><input class="alignright" type=text />Gallery name: </span>';q+='<select id="cat" class="hide">';q+=p;q+='</select>';q+='</p>';if(l.length>1){q+='<div class="dashed"></div>';q+='<p>Or select destination for each file</p>';for(var i=0;i<l.length;i++){q+='<div class="option">'+l[i].name+'<select id="dest'+i+'" class="file" name="file'+i+'">';q+=n;q+='</select>';q+='<span id="wg_'+i+'" class="hide gallery_name"><input class="alignright" type=text />Gallery name:</span>';q+='<select id="cat'+i+'" class="hide">';q+=p;q+='</select></div>'}}var r=jQuery("<div id='dest-popup' />").html(q);var s=function(i){var b=l[i].getSource();b.index=i;if(b.name.split('.').pop()=='mp3'){ID3.loadTags(b.name,function(){var a=ID3.getAllTags(b.name);l[b.index].album=a.album;if(b.index<l.length-1)s(b.index+1)},{tags:["album"],dataReader:mOxieFileAPIReader(b)})}else if(b.index<l.length-1)s(b.index+1)};s(0);var t=function(e){jQuery('#dest-popup .error').remove();var d=jQuery('#dest :selected').val();var f=jQuery('.file :selected');if(e.target.id=="dest"&&d.length==0)return false;else if(d.length){for(var i=0;i<l.length;i++)l[i].dest=d;if(destinations[d]&&destinations[d][2]=='Category'){if(jQuery("#adv_cat").val()==''){jQuery("<div>").attr({'id':'adv_err_cat','class':'clear alignright media-item error'}).html('You must enter an existing category').insertAfter('#ac_cat');return false}for(var i=0;i<l.length;i++)l[i].album=jQuery("#adv_cat").val()}else if(destinations[d]&&destinations[d][2]=='Wordpress Gallery'&&destinations[d][3]=='new'){if(jQuery("#wg_ input").val()==''){jQuery("<div>").attr({'id':'adv_err_gal','class':'clear alignright media-item error'}).html('You must enter a name for the new gallery').insertAfter('#wg_ input');return false}jQuery.post(ajaxurl,{'action':'adv_file_upload_new_post','security':security,'title':JSON.stringify(new Array(jQuery("#wg_ input").val()))},function(a){for(var i=0;i<l.length;i++)l[i].album=a[0].id;m();r.dialog('close')},"json");return false}m();r.dialog('close')}else if(f.length){var g=false;var h=false;var j=new Object();for(var i=0;i<f.length;i++){var k=f[i].value;if(k.length==0){jQuery("<div>").attr({'class':'clear alignright media-item error'}).html('You must enter a destination').insertAfter('#dest'+i);g=true}else{l[i].dest=k;if(destinations[k]&&destinations[k][2]=='Category'){if(jQuery("#adv_cat"+i).val()==''){jQuery("<div>").attr({'id':'adv_err_cat'+i,'class':'clear alignright media-item error'}).html('You must enter an existing category').insertAfter('#ac_cat'+i);h=true}l[i].album=jQuery("#adv_cat"+i).val()}else if(destinations[k]&&destinations[k][2]=='Wordpress Gallery'&&destinations[k][3]=='new'){if(jQuery("#wg_"+i+" input").val()==''){jQuery("<div>").attr({'id':'adv_err_gal'+i,'class':'clear alignright media-item error'}).html('You must enter a name for the new gallery').insertAfter('#wg_'+i+' input');h=true}if(typeof j[jQuery("#wg_"+i+" input").val()]==='undefined')j[jQuery("#wg_"+i+" input").val()]=i.toString();else j[jQuery("#wg_"+i+" input").val()]+=','+i.toString()}}}if(g){jQuery("<div>").attr({'class':'clear alignright media-item error'}).html('You must enter a destination for all files').insertAfter('#dest');return false}if(h)return false;if(!jQuery.isEmptyObject(j)){jQuery.post(ajaxurl,{'action':'adv_file_upload_new_post','security':security,'title':JSON.stringify(Object.keys(j))},function(a){for(var b in a){var c=j[a[b].title].split(",");for(var i=0;i<c.length;i++)l[c[i]].album=a[b].id}m();r.dialog('close')},"json");return false}else{m();r.dialog('close')}}else{jQuery("<div>").attr({'class':'clear alignright media-item error'}).html('You must enter a destination').insertAfter('#dest');return false}};var u=function(e){var a=e.target.id.match(/^dest(.*)/)[1];var b='cat'+a;if(destinations[e.target.selectedIndex-1]&&destinations[e.target.selectedIndex-1][2]=='Category'){jQuery("#wg_"+a).hide();jQuery("#adv_err_gal"+a).remove();if(jQuery("#ac_"+b).length==0){jQuery("#"+b).combobox({desc:'adv_'+b,id:'ac_'+b});if(a=='')a=0;if(l[a].album)jQuery('#ac_'+b+' input').val(l[a].album)}else jQuery("#ac_"+b).show()}else if(destinations[e.target.selectedIndex-1]&&destinations[e.target.selectedIndex-1][2]=='Wordpress Gallery'&&destinations[e.target.selectedIndex-1][3]=='new'){jQuery("#ac_"+b).hide();jQuery("#adv_err_"+b).remove();jQuery("#wg_"+a).css("display","block")}else{jQuery("#wg_"+a).hide();jQuery("#ac_"+b).hide();jQuery("#adv_err_"+b).remove();jQuery("#adv_err_gal"+a).remove();if(a=='')t(e)}};jQuery(document).on('change','.ui-dialog select',u);r.dialog({'title':'Destination','width':'auto','modal':true,'autoOpen':false,'closeOnEscape':true,'buttons':[{'text':'Cancel','class':'button-primary','click':function(){jQuery(this).dialog('close')}},{'text':'Select','class':'button-primary','click':t}],'close':function(){jQuery(document).off('change','.ui-dialog select',u);jQuery('.ui-widget-overlay').remove();jQuery('.ui-dialog').remove();jQuery('.ui-autocomplete').remove()}});r.dialog('open')}(function($){$.widget("custom.combobox",{_create:function(){this.wrapper=$("<div>").addClass("custom-combobox").attr('id',this.options.id).insertAfter(this.element);this.element.hide();this._createAutocomplete();this._createShowAllButton()},_createAutocomplete:function(){var c=this.element.children(":selected"),value=c.val()?c.text():"";this.input=$("<input>").appendTo(this.wrapper).attr('id',this.options.desc).attr('name',this.options.desc).val(value).attr("title","").addClass("custom-combobox-input ui-widget ui-widget-content ui-state-default ui-corner-all").autocomplete({delay:0,minLength:0,source:$.proxy(this,"_source")});this._on(this.input,{autocompleteselect:function(a,b){b.item.option.selected=true;this._trigger("select",a,{item:b.item.option})},autocompletechange:"_removeIfInvalid"})},_createShowAllButton:function(){var a=this.input,wasOpen=false;$("<a>").attr("tabIndex",-1).attr("title","Show All Items").height($('#'+this.options.desc).innerHeight()-6).appendTo(this.wrapper).button({icons:{primary:"ui-icon-triangle-1-s"},text:false}).removeClass("ui-corner-all").addClass("custom-combobox-toggle").mousedown(function(){wasOpen=a.autocomplete("widget").is(":visible")}).click(function(){a.focus();if(wasOpen){return}a.autocomplete("search","")})},_source:function(b,c){var d=new RegExp($.ui.autocomplete.escapeRegex(b.term),"i");c(this.element.children("option").map(function(){var a=$(this).text();if(this.value&&(!b.term||d.test(a)))return{label:a,value:a,option:this}}))},_removeIfInvalid:function(a,b){if(b.item){return}var c=this.input.val(),valueLowerCase=c.toLowerCase(),valid=false;this.element.children("option").each(function(){if($(this).text().toLowerCase()===valueLowerCase){this.selected=valid=true;return false}});if(valid){return}this.input.val("");this.element.val("");this.input.data("ui-autocomplete").term=""},_destroy:function(){this.wrapper.remove();this.element.show()}})})(jQuery);